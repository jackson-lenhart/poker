<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        width: 100%;
      }

      .container {
        align-items: center;
        display: flex;
        justify-content: center;
        height: 100%;
      }

      .error-msg {
        color: red;
      }
    </style>
    <script>
      /* GLOBALS */

      var container;
      var player = { username: localStorage.getItem('username') };
      var opponents = [];
      var hand;

      /* COMPONENTS */

      // Loading spinner
      var spinner = document.createElement('div');
      spinner.id = 'spinner';
      var spinnerText = document.createTextNode('Loading...');
      spinner.appendChild(spinnerText);

      // Login form
      var loginForm = document.createElement('form');
      loginForm.id = 'login-form';
      // login function defined below
      loginForm.onsubmit = login;

      var usernameLabel = document.createElement('label');
      usernameLabel.htmlFor = 'username';
      usernameLabel.textContent = 'Username:';

      var usernameField = document.createElement('input');
      usernameField.type = 'text';
      usernameField.name = 'username';
      usernameField.id = 'username';

      loginForm.appendChild(usernameLabel);
      loginForm.appendChild(usernameField);

      // Game
      var game = document.createElement('div');
      game.id = 'game';

      // Ready button (player clicks to signify ready to begin new hand)
      var readyButton = document.createElement('button');
      readyButton.type = 'button';
      readyButton.textContent = 'Ready';
      // TODO
      readyButton.onclick = signifyReadiness;

      // Waiting text (this probably shouldn't be global but w/e)
      var waitingText = document.createTextNode('Waiting for others to join...');
      var readyWaitingText = document.createTextNode('Waiting for others to signify readiness');

      window.onload = function() {
        // Our main container where we dynamically inject html
        container = document.getElementById('container');
        container.appendChild(spinner);
      };

      var ws = new WebSocket('ws://localhost:9090');

      ws.onopen = function() {
        if (player.username) {
          var gatewayData = { type: 'gateway', username: player.username };
          ws.send(JSON.stringify(gatewayData));
        }
        else {
          container.removeChild(spinner);
          container.appendChild(loginForm);
        }
      };

      ws.onmessage = function(message) {
        var messageData = JSON.parse(message.data);

        switch(messageData.type) {
          case 'login':
            player = messageData.player;
            opponents = messageData.opponents;
            initGame();

            localStorage.setItem('username', player.username);
            break;

          case 'login-failure':
            alert('Error: ' + messageData.msg);

            container.removeChild(spinner);
            container.appendChild(loginForm);
            break;

          case 'gateway':
            player = messageData.player;
            opponents = messageData.opponents;
            // This will be null if we're not in hand
            hand = messageData.hand;

            if (player.ready) resumeGame();
            else initGame();
            break;

          case 'gateway-failure':
            container.removeChild(spinner);
            container.appendChild(loginForm);

            localStorage.removeItem('username');
            break;

          case 'join':
            opponents.push(messageData.playerJoined);
            // Render Ready button if we just got our first opponent
            if (opponents.length === 1) {
              game.removeChild(waitingText);
              game.appendChild(readyButton);
            }
            break;

          case 'hand':
            hand = messageData.hand;
            renderHand();
            game.removeChild(readyWaitingText);
            break;

          default:
            console.error('Unrecognized message type:', messageData.type);
        }
      };

      function login(event) {
        event.preventDefault();

        var container = document.getElementById('container');

        var usernameInput = document.getElementById('username');
        var username = usernameInput.value;

        if (username === '') {
          usernameInput.style.color = 'red';
          alert('Error: please enter a username');
          return;
        }

        container.removeChild(loginForm);
        container.appendChild(spinner);

        var loginData = { type: 'login', username: username };
        ws.send(JSON.stringify(loginData));
      }

      // If player has just refreshed the page or logged in, this will be called.
      function initGame() {
        var playerText = document.createTextNode('You');
        var stackText = document.createTextNode(player.stack);

        game.appendChild(playerText);

        var br = document.createElement('br');
        game.appendChild(br);

        game.appendChild(stackText);

        var br2 = document.createElement('br');
        game.appendChild(br2);

        if (opponents.length >= 1) {
          game.appendChild(readyButton);
        }
        else {
          game.appendChild(waitingText);
        }

        container.removeChild(spinner);
        container.appendChild(game);
      }

      function signifyReadiness() {
        game.removeChild(readyButton);
        game.appendChild(readyWaitingText);

        var readyData = { type: 'ready', username: player.username };
        ws.send(JSON.stringify(readyData));
      }

      // If player has signified readiness/hand is in progress, this will be called.
      function resumeGame() {
        var playerText = document.createTextNode('You');
        var stackText = document.createTextNode(player.stack);

        game.appendChild(playerText);

        var br = document.createElement('br');
        game.appendChild(br);

        game.appendChild(stackText);

        var br2 = document.createElement('br');
        game.appendChild(br2);

        if (hand) renderHand();
        else game.appendChild(waitingText);

        container.removeChild(spinner);
        container.appendChild(game);
      }

      function renderHand() {
        var handContainer = document.createElement('div');
        var handTextElement = document.createElement('h3');
        handTextElement.textContent = JSON.stringify(hand);
        handContainer.appendChild(handTextElement);
        game.prepend(handContainer);
      }
    </script>
    <title>Poker</title>
  </head>
  <body>
    <div class="container" id="container"></div>
  </body>
</html>
